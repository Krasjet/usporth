Î¼sporth
=======

A minimal rewrite of the core of Paul Batchelor's Sporth [1],
a small stack-based audio programming language.

Currently a work in progress.

Usage
-----

JACK interface:

  $ usporth_jack in.usp

Text interface:

  $ usporth_text [-n nsamples] [-r sr] in.usp
  $ usporth_text [-n nsamples] [-r sr] in.usp < in.txt

  Examples:

    $ usporth_text -n 20 -r 48000 examples/sine.usp
    $ echo '1 2 3' | usporth_text -n 3 examples/in.usp

WAV interface:

  $ usporth_wav [-t nsecs] [-r sr] [-o out.wav] in.usp
  $ usporth_wav [-t nsecs] -i in.wav [-o out.wav] in.usp

  Examples:

    $ usporth_wav -t 3 -r 8000 -o sine.wav examples/sine.usp
    $ usporth_wav -i sine.wav -o sine_out.wav examples/in.usp

Build
-----

To build the JACK interface, you need JACK [2] installed on
your system, and to build the WAV interface, you need
libsndfile [3] installed.

Then use

    $ ./configure

to generate a `config.mk` file containing compiler flags,
and run

    $ make

to build the programs.

Adding a new ugen
-----------------

To add a new unit generator, e.g. inv,

1. Create `inv.c` in `ugens` directory.

2. Define init, tick, and free functions for the new ugen.
   The name and prototype of the functions must match the
   following:

     ugen_status ugen_inv_init(usp_ctx *ctx, ugen_instance *pugen)
     ugen_status ugen_inv_tick(usp_ctx *ctx, ugen_instance ugen)
     void ugen_inv_free(ugen_instance ugen)

  See existing implementations in `ugens` directory for some
  examples.

3. Add documentation to `ugens.lua`, e.g.

     ['inv'] = {
       input = {
         {name = 'v', type = 'f', cond = 'x != 0'},
       },
       output = {
         {name = 'inv', type = 'f'},
       },
       description = 'compute 1 / v'
     },

   to the `ugens` table.

4. Run

     $ ./ugens.lua

   to regenerate `ugens.h`.

5. Update the makefile to include the new object file
   `ugens/inv.o` to `OBJ` and add dependency

     ugens/inv.o: usporth.h

   This step might be automated in the future.

[1]: https://pbat.ch/proj/sporth.html
[2]: https://jackaudio.org/
[3]: https://libsndfile.github.io/libsndfile/
