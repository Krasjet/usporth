Î¼sporth
=======

A minimal rewrite of the core of Paul Batchelor's Sporth [1],
a small stack-based audio programming language.

Currently a work in progress.

Usage
-----

JACK interface:

  $ usporth_jack in.usp

Text interface:

  $ usporth_text [-n nsamples] [-r sr] in.usp
  $ usporth_text [-n nsamples] [-r sr] in.usp < in.txt

  Examples:

    $ usporth_text -n 20 -r 48000 examples/sine.usp
    $ echo '1 2 3' | usporth_text -n 3 examples/in.usp

WAV interface:

  $ usporth_wav [-t nsecs] [-r sr] [-o out.wav] in.usp
  $ usporth_wav [-t nsecs] -i in.wav [-o out.wav] in.usp

  Examples:

    $ usporth_wav -t 3 -r 8000 -o sine.wav examples/sine.usp
    $ usporth_wav -i sine.wav -o sine_out.wav examples/in.usp

Build
-----

To build the JACK interface, you need JACK [2] installed on
your system, and to build the WAV interface, you need
libsndfile [3] installed. If you want to add new ugens, you
also need to have lua installed.

The text interface only requires a C99-compatible C compiler
to build.

For Arch-based distros, you can use install all the optional
dependencies by

  $ pacman -S jack2 libsndfile lua

For Debian-based distros, install by

  $ apt-get install libjack-jackd2-dev libsndfile1-dev lua5.1

For macOS, you can use Homebrew [4]:

  $ brew install pkgconf jack libsndfile lua

For Windows, you can use MSYS2 with MinGW [5]:

  $ pacman -S pkg-config mingw-w64-x86_64-libsndfile mingw-w64-x86_64-lua

  For JACK, you need to build it from source:

    $ pacman -S git base-devel python mingw-w64-x86_64-toolchain
    $ git clone git://github.com/jackaudio/jack2.git
    $ cd jack2
    $ ./waf configure \
          --prefix=${MINGW_PREFIX} \
          --check-c-compiler=gcc \
          --check-cxx-compiler=g++
    $ ./waf build
    $ ./waf install

After you have sorted out the dependencies, use

  $ ./configure

to generate a `config.mk` file containing compiler flags,
and run

  $ make

to build the programs.

Adding a new ugen
-----------------

To add a new unit generator, e.g. inv,

1. Create `inv.c` in `ugens` directory.

2. Define init, tick, and free functions for the new ugen.
   The name and prototype of the functions must match the
   following:

     ugen_status ugen_inv_init(usp_ctx *ctx, ugen_instance *pugen)
     ugen_status ugen_inv_tick(usp_ctx *ctx, ugen_instance ugen)
     void ugen_inv_free(ugen_instance ugen)

  See existing implementations in `ugens` directory for some
  examples.

3. Add documentation to `ugens.lua`, e.g.

     ['inv'] = {
       input = {
         {name = 'v', type = 'f', cond = 'x != 0'},
       },
       output = {
         {name = 'inv', type = 'f'},
       },
       description = 'compute 1 / v'
     },

   to the `ugens` table.

4. Run

     $ ./ugens.lua

   to regenerate `ugens.h`. You need to have lua installed
   for this.

5. Update the makefile to include the new object file
   `ugens/inv.o` to `OBJ` and add dependency

     ugens/inv.o: usporth.h

   This step might be automated in the future.

[1]: https://pbat.ch/proj/sporth.html
[2]: https://jackaudio.org/
[3]: https://libsndfile.github.io/libsndfile/
[4]: https://brew.sh/
[5]: https://www.msys2.org/
